!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./grid.grouping"],e):e(jQuery)}(function(B){"use strict";B.assocArraySize=function(e){var r,o=0;for(r in e)e.hasOwnProperty(r)&&o++;return o},B.jgrid.extend({pivotSetup:function(N,e){var A=[],k=[],G=[],M=[],z=[],V={grouping:!0,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},q=[],Q=B.extend({rowTotals:!1,rowTotalsText:"Total",colTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1},e||{});return this.each(function(){var p,d,f,e,r,c=this,o=N.length,t=0;function a(e,r){var o,t=0,a=!0;for(o in e)if(e.hasOwnProperty(o)){if(e[o]!=this[t]){a=!1;break}if(++t>=this.length)break}return a&&(D=r),a}function n(e,r,o,t){var a,n,i,s,l=r.length,g="",u=[],m=1;for(Array.isArray(o)?(i=o.length,u=o):(i=1,u[0]=o),z=[],n=(M=[]).root=0;n<i;n++){for(var p,d=[],f=0;f<l;f++){if(s="string"==typeof r[f].aggregator?r[f].aggregator:"cust",null==o)p=a=B.jgrid.trim(r[f].member)+"_"+s,u[0]=r[f].label||s+" "+B.jgrid.trim(r[f].member);else{p=o[n].replace(/\s+/g,"");try{a=1===l?g+p:g+p+"_"+s+"_"+String(f)}catch(e){}u[n]=o[n]}a=isNaN(parseInt(a,10))?a:a+" ","avg"===r[f].aggregator&&(s=-1===D?k.length+"_"+a:D+"_"+a,h[s]?h[s]++:h[s]=1,m=h[s]),t[a]=d[a]=function(e,r,o,t,a){var n;if(B.jgrid.isFunction(e))n=e.call(c,r,o,t);else switch(e){case"sum":n=parseFloat(r||0)+parseFloat(t[o]||0);break;case"count":""!==r&&null!=r||(r=0),n=t.hasOwnProperty(o)?r+1:0;break;case"min":n=""===r||null==r?parseFloat(t[o]||0):Math.min(parseFloat(r),parseFloat(t[o]||0));break;case"max":n=""===r||null==r?parseFloat(t[o]||0):Math.max(parseFloat(r),parseFloat(t[o]||0));break;case"avg":n=(parseFloat(r||0)*(a-1)+parseFloat(t[o]||0))/a}return n}(r[f].aggregator,t[a],r[f].member,e,m)}g+=o&&null!=o[n]?o[n].replace(/\s+/g,""):"",M[a]=d,z[a]=u[n]}return t}if(Q.rowTotals&&0<Q.yDimension.length&&(e=Q.yDimension[0].dataName,Q.yDimension.splice(0,0,{dataName:e}),Q.yDimension[0].converter=function(){return"_r_Totals"}),p=Array.isArray(Q.xDimension)?Q.xDimension.length:0,d=Q.yDimension.length,f=Array.isArray(Q.aggregates)?Q.aggregates.length:0,0===p||0===f)throw"xDimension or aggregates optiona are not set!";for(x=0;x<p;x++)r={name:Q.xDimension[x].dataName,frozen:Q.frozenStaticCols},null==Q.xDimension[x].isGroupField&&(Q.xDimension[x].isGroupField=!0),r=B.extend(!0,r,Q.xDimension[x]),A.push(r);for(var i,s,l=p-1,g={},h=[];t<o;){for(var u=N[t],m=[],v=[],y={},x=0;m[x]=B.jgrid.trim(u[Q.xDimension[x].dataName]),y[Q.xDimension[x].dataName]=m[x],++x<p;);var b,w=0,D=-1;if(i=k,b=0<(s=function(e,r){var o,t,a,n=[];if(!this||"function"!=typeof e||e instanceof RegExp)throw new TypeError;for(a=this.length,o=0;o<a;o++)if(this.hasOwnProperty(o)&&(t=this[o],e.call(r,t,o,this))){n.push(t);break}return n}.call(i,a,s=m)).length?s[0]:null){if(0<=D){if(w=0,1<=d){for(w=0;w<d;w++)v[w]=B.jgrid.trim(u[Q.yDimension[w].dataName]),Q.yDimension[w].converter&&B.jgrid.isFunction(Q.yDimension[w].converter)&&(v[w]=Q.yDimension[w].converter.call(this,v[w],m,v));b=n(u,Q.aggregates,v,b)}else 0===d&&(b=n(u,Q.aggregates,null,b));k[D]=b}}else{if(w=0,1<=d){for(w=0;w<d;w++)v[w]=B.jgrid.trim(u[Q.yDimension[w].dataName]),Q.yDimension[w].converter&&B.jgrid.isFunction(Q.yDimension[w].converter)&&(v[w]=Q.yDimension[w].converter.call(this,v[w],m,v));y=n(u,Q.aggregates,v,y)}else 0===d&&(y=n(u,Q.aggregates,null,y));k.push(y)}var j,F=0,O=null,S=null;for(j in M)if(M.hasOwnProperty(j)){if(0===F)O=(g=g.children&&void 0!==g.children?g:{text:j,level:0,children:[],label:j}).children;else{for(S=null,x=0;x<O.length;x++)if(O[x].text===j){S=O[x];break}O=S?S.children:(O.push({children:[],text:j,level:F,fields:M[j],label:z[j]}),O[O.length-1].children)}F++}t++}var T,h=null,C=[],P=A.length,_=P;if(0<d&&(q[d-1]={useColSpanStyle:!1,groupHeaders:[]}),function e(r){var o,t,a,n,i;for(a in r)if(r.hasOwnProperty(a)){if("object"!=typeof r[a]){if("level"===a){if(void 0===C[r.level]&&(C[r.level]="",0<r.level&&-1===r.text.indexOf("_r_Totals")&&(q[r.level-1]={useColSpanStyle:!1,groupHeaders:[]})),C[r.level]!==r.text&&r.children.length&&-1===r.text.indexOf("_r_Totals")&&0<r.level){q[r.level-1].groupHeaders.push({titleText:r.label,numberOfColumns:0});var s=q[r.level-1].groupHeaders.length-1,l=0==s?_:P;if(r.level-1==(Q.rowTotals?1:0)&&0<s){for(var g=0,u=0;u<s;u++)g+=q[r.level-1].groupHeaders[u].numberOfColumns;g&&(l=g+p)}A[l]&&(q[r.level-1].groupHeaders[s].startColumnName=A[l].name,q[r.level-1].groupHeaders[s].numberOfColumns=A.length-l),P=A.length}C[r.level]=r.text}if(r.level===d&&"level"===a&&0<d)if(1<f){var m=1;for(o in r.fields)r.fields.hasOwnProperty(o)&&(1===m&&q[d-1].groupHeaders.push({startColumnName:o,numberOfColumns:1,titleText:r.label||r.text}),m++);q[d-1].groupHeaders[q[d-1].groupHeaders.length-1].numberOfColumns=m-1}else q.splice(d-1,1)}if(null!=r[a]&&"object"==typeof r[a]&&e(r[a]),"level"===a&&0<r.level&&(r.level===(0===d?r.level:d)||-1!==C[r.level].indexOf("_r_Totals")))for(o in t=0,r.fields)if(r.fields.hasOwnProperty(o)){for(n in i={},Q.aggregates[t])if(Q.aggregates[t].hasOwnProperty(n))switch(n){case"member":case"label":case"aggregator":break;default:i[n]=Q.aggregates[t][n]}1<f?(i.name=o,i.label=Q.aggregates[t].label||r.label):(i.name=r.text,i.label="_r_Totals"===r.text?Q.rowTotalsText:r.label),A.push(i),t++}}}(g),Q.colTotals)for(var H=k.length;H--;)for(x=p;x<A.length;x++)T=A[x].name,G[T]?G[T]+=parseFloat(k[H][T]||0):G[T]=parseFloat(k[H][T]||0);if(0<l)for(x=0;x<l;x++)A[x].isGroupField&&(V.groupingView.groupField.push(A[x].name),V.groupingView.groupSummary.push(Q.groupSummary),V.groupingView.groupSummaryPos.push(Q.groupSummaryPos));else V.grouping=!1;V.sortname=A[l].name,V.groupingView.hideFirstGroupCol=!0}),{colModel:A,rows:k,groupOptions:V,groupHeaders:q,summary:G}},jqPivot:function(o,g,u,t){return this.each(function(){var l=this,e=u.regional||"en";function r(e){B.jgrid.isFunction(g.onInitPivot)&&g.onInitPivot.call(l),Array.isArray(e)||(e=[]);var r,o,t,a,n=jQuery(l).jqGrid("pivotSetup",e,g),e=0<B.assocArraySize(n.summary),i=B.jgrid.from.call(l,n.rows);for(g.ignoreCase&&(i=i.ignoreCase()),r=0;r<n.groupOptions.groupingView.groupField.length;r++)o=g.xDimension[r].sortorder||"asc",t=g.xDimension[r].sorttype||"text",i.orderBy(n.groupOptions.groupingView.groupField[r],o,t,"",t);if(a=g.xDimension.length,u.sortname){for(o=u.sortorder||"asc",t="text",r=0;r<a;r++)if(g.xDimension[r].dataName===u.sortname){t=g.xDimension[r].sorttype||"text";break}i.orderBy(u.sortname,o,t,"",t)}else n.groupOptions.sortname&&a&&(o=g.xDimension[a-1].sortorder||"asc",t=g.xDimension[a-1].sorttype||"text",i.orderBy(n.groupOptions.sortname,o,t,"",t));jQuery(l).jqGrid(B.extend(!0,{datastr:B.extend(i.select(),e?{userdata:n.summary}:{}),datatype:"jsonstring",footerrow:e,userDataOnFooter:e,colModel:n.colModel,viewrecords:!0,formatFooterData:!0===g.colTotals,sortname:g.xDimension[0].dataName},n.groupOptions,u||{}));var s=n.groupHeaders;if(s.length)for(r=0;r<s.length;r++)s[r]&&s[r].groupHeaders.length&&jQuery(l).jqGrid("setGroupHeaders",s[r]);g.frozenStaticCols&&jQuery(l).jqGrid("setFrozenColumns"),B.jgrid.isFunction(g.onCompletePivot)&&g.onCompletePivot.call(l),g.loadMsg&&B(".loading_pivot").remove()}void 0===g.loadMsg&&(g.loadMsg=!0),g.loadMsg&&B("<div class='loading_pivot ui-state-default ui-state-active row'>"+B.jgrid.getRegional(l,"regional."+e+".defaults.loadtext")+"</div>").insertBefore(l).show(),"string"==typeof o?B.ajax(B.extend({url:o,dataType:"json",success:function(e){r(B.jgrid.getAccessor(e,t&&t.reader?t.reader:"rows"))}},t||{})):r(o)})}})});